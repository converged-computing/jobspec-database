#!/bin/bash
#SBATCH --time=30:00:00
#SBATCH  -N 4
#SBATCH --account=snic2020-1-40
#SBATCH -J voltage
#SBATCH --exclusive
#SBATCH --ntasks-per-node=32
module load Siesta/4.1-b4-nsc2-intel-2018a-eb

mkdir cont   # read the comment at the end of this script.

#VOLTS=" 0.2 0.4 0.6 0.8 1.0 "
VOLTS="0.25 0.50 0.75 1.0"
for i in $VOLTS

do

cp -r cont $i
cd $i


cp ../*.ion .
cp ../*.TSHS .
cp ../*.TSDE .
cp ../*.DM .

cat > POSCAR.fdf  <<EOF

SolutionMethod        Transiesta

SystemName Bi scattering region  
SystemLabel bi_scat


==================================================
==================================================
# SPECIES AND BASIS

# Number of species 
NumberOfSpecies 1
%block ChemicalSpeciesLabel
  1  83 Bi 
%endblock ChemicalSpeciesLabel

PAO.BasisSize    DZP
PAO.EnergyShift  0.005 Ry
XC.functional   GGA
XC.authors      PBE


==================================================
==================================================

# K-points

%block kgrid_Monkhorst_Pack
20    0    0    0.0
 0    1    0    0.0
 0    0   100   0.0
%endblock kgrid_Monkhorst_Pack


==================================================
==================================================

# Structure
NumberOfAtoms 288
LatticeConstant 1.0 Ang

%block LatticeVectors
 45.3104496000 0.0000000000 0.0000000000
 0.0000000000 20.0000000000 0.0000000000
 0.0000000000 0.0000000000 52.3200016020
%endblock LatticeVectors

AtomicCoordinatesFormat Ang
%block  AtomicCoordinatesAndAtomicSpecies
   2.51601362	   11.75619984       0.00000000       1 
   6.29188442	   11.75619984       2.18000007       1 
   7.55045795	   10.02980042       0.00000000       1 
   3.77458715	   10.02980042       2.18000007       1 
   2.51601362	   11.75619984       4.36000013       1 
   6.29188442	   11.75619984       6.54000020       1 
   7.55045795	   10.02980042       4.36000013       1 
   3.77458715	   10.02980042       6.54000020       1 
  10.06775522	   11.75619984       0.00000000       1 
  13.84362602	   11.75619984       2.18000007       1 
  15.10219955	   10.02980042       0.00000000       1 
  11.32632875	   10.02980042       2.18000007       1 
  10.06775522	   11.75619984       4.36000013       1 
  13.84362602	   11.75619984       6.54000020       1 
  15.10219955	   10.02980042       4.36000013       1 
  11.32632875	   10.02980042       6.54000020       1 
  17.61949682	   11.75619984       0.00000000       1 
  21.39536762	   11.75619984       2.18000007       1 
  22.65394115	   10.02980042       0.00000000       1 
  18.87807035	   10.02980042       2.18000007       1 
  17.61949682	   11.75619984       4.36000013       1 
  21.39536762	   11.75619984       6.54000020       1 
  22.65394115	   10.02980042       4.36000013       1 
  18.87807035	   10.02980042       6.54000020       1 
  25.17123842	   11.75619984       0.00000000       1 
  28.94710922	   11.75619984       2.18000007       1 
  30.20568275	   10.02980042       0.00000000       1 
  26.42981195	   10.02980042       2.18000007       1 
  25.17123842	   11.75619984       4.36000013       1 
  28.94710922	   11.75619984       6.54000020       1 
  30.20568275	   10.02980042       4.36000013       1 
  26.42981195	   10.02980042       6.54000020       1 
  32.72298002	   11.75619984       0.00000000       1 
  36.49885082	   11.75619984       2.18000007       1 
  37.75742435	   10.02980042       0.00000000       1 
  33.98155355	   10.02980042       2.18000007       1 
  32.72298002	   11.75619984       4.36000013       1 
  36.49885082	   11.75619984       6.54000020       1 
  37.75742435	   10.02980042       4.36000013       1 
  33.98155355	   10.02980042       6.54000020       1 
  40.27472162	   11.75619984       0.00000000       1 
  44.05059242	   11.75619984       2.18000007       1 
  45.30916595	   10.02980042       0.00000000       1 
  41.53329515	   10.02980042       2.18000007       1 
  40.27472162	   11.75619984       4.36000013       1 
  44.05059242	   11.75619984       6.54000020       1 
  45.30916595	   10.02980042       4.36000013       1 
  41.53329515	   10.02980042       6.54000020       1 
   2.51601362	   11.75619984       8.72000027       1 
   6.29188442	   11.75619984      10.90000033       1 
   7.55045795	   10.02980042       8.72000027       1 
   3.77458715	   10.02980042      10.90000033       1 
   2.51601362	   11.75619984      13.08000040       1 
   6.29188442	   11.75619984      15.26000047       1 
   7.55045795	   10.02980042      13.08000040       1 
   3.77458715	   10.02980042      15.26000047       1 
  10.06775522	   11.75619984       8.72000027       1 
  13.84362602	   11.75619984      10.90000033       1 
  15.10219955	   10.02980042       8.72000027       1 
  11.32632875	   10.02980042      10.90000033       1 
  10.06775522	   11.75619984      13.08000040       1 
  13.84362602	   11.75619984      15.26000047       1 
  15.10219955	   10.02980042      13.08000040       1 
  11.32632875	   10.02980042      15.26000047       1 
  17.61949682	   11.75619984       8.72000027       1 
  21.39536762	   11.75619984      10.90000033       1 
  22.65394115	   10.02980042       8.72000027       1 
  18.87807035	   10.02980042      10.90000033       1 
  17.61949682	   11.75619984      13.08000040       1 
  21.39536762	   11.75619984      15.26000047       1 
  22.65394115	   10.02980042      13.08000040       1 
  18.87807035	   10.02980042      15.26000047       1 
  25.17123842	   11.75619984       8.72000027       1 
  28.94710922	   11.75619984      10.90000033       1 
  30.20568275	   10.02980042       8.72000027       1 
  26.42981195	   10.02980042      10.90000033       1 
  25.17123842	   11.75619984      13.08000040       1 
  28.94710922	   11.75619984      15.26000047       1 
  30.20568275	   10.02980042      13.08000040       1 
  26.42981195	   10.02980042      15.26000047       1 
  32.72298002	   11.75619984       8.72000027       1 
  36.49885082	   11.75619984      10.90000033       1 
  37.75742435	   10.02980042       8.72000027       1 
  33.98155355	   10.02980042      10.90000033       1 
  32.72298002	   11.75619984      13.08000040       1 
  36.49885082	   11.75619984      15.26000047       1 
  37.75742435	   10.02980042      13.08000040       1 
  33.98155355	   10.02980042      15.26000047       1 
  40.27472162	   11.75619984       8.72000027       1 
  44.05059242	   11.75619984      10.90000033       1 
  45.30916595	   10.02980042       8.72000027       1 
  41.53329515	   10.02980042      10.90000033       1 
  40.27472162	   11.75619984      13.08000040       1 
  44.05059242	   11.75619984      15.26000047       1 
  45.30916595	   10.02980042      13.08000040       1 
  41.53329515	   10.02980042      15.26000047       1 
   2.51601362	   11.75619984      17.44000053       1 
   6.29188442	   11.75619984      19.62000060       1 
   7.55045795	   10.02980042      17.44000053       1 
   3.77458715	   10.02980042      19.62000060       1 
   2.51601362	   11.75619984      21.80000067       1 
   6.29188442	   11.75619984      23.98000073       1 
   7.55045795	   10.02980042      21.80000067       1 
   3.77458715	   10.02980042      23.98000073       1 
  10.06775522	   11.75619984      17.44000053       1 
  13.84362602	   11.75619984      19.62000060       1 
  15.10219955	   10.02980042      17.44000053       1 
  11.32632875	   10.02980042      19.62000060       1 
  10.06775522	   11.75619984      21.80000067       1 
  13.84362602	   11.75619984      23.98000073       1 
  15.10219955	   10.02980042      21.80000067       1 
  11.32632875	   10.02980042      23.98000073       1 
  17.61949682	   11.75619984      17.44000053       1 
  21.39536762	   11.75619984      19.62000060       1 
  22.65394115	   10.02980042      17.44000053       1 
  18.87807035	   10.02980042      19.62000060       1 
  17.61949682	   11.75619984      21.80000067       1 
  21.39536762	   11.75619984      23.98000073       1 
  22.65394115	   10.02980042      21.80000067       1 
  18.87807035	   10.02980042      23.98000073       1 
  25.17123842	   11.75619984      17.44000053       1 
  28.94710922	   11.75619984      19.62000060       1 
  30.20568275	   10.02980042      17.44000053       1 
  26.42981195	   10.02980042      19.62000060       1 
  25.17123842	   11.75619984      21.80000067       1 
  28.94710922	   11.75619984      23.98000073       1 
  30.20568275	   10.02980042      21.80000067       1 
  26.42981195	   10.02980042      23.98000073       1 
  32.72298002	   11.75619984      17.44000053       1 
  36.49885082	   11.75619984      19.62000060       1 
  37.75742435	   10.02980042      17.44000053       1 
  33.98155355	   10.02980042      19.62000060       1 
  32.72298002	   11.75619984      21.80000067       1 
  36.49885082	   11.75619984      23.98000073       1 
  37.75742435	   10.02980042      21.80000067       1 
  33.98155355	   10.02980042      23.98000073       1 
  40.27472162	   11.75619984      17.44000053       1 
  44.05059242	   11.75619984      19.62000060       1 
  45.30916595	   10.02980042      17.44000053       1 
  41.53329515	   10.02980042      19.62000060       1 
  40.27472162	   11.75619984      21.80000067       1 
  44.05059242	   11.75619984      23.98000073       1 
  45.30916595	   10.02980042      21.80000067       1 
  41.53329515	   10.02980042      23.98000073       1 
   2.51601362	   11.75619984      26.16000080       1 
   6.29188442	   11.75619984      28.34000087       1 
   7.55045795	   10.02980042      26.16000080       1 
   3.77458715	   10.02980042      28.34000087       1 
   2.51601362	   11.75619984      30.52000093       1 
   6.29188442	   11.75619984      32.70000100       1 
   7.55045795	   10.02980042      30.52000093       1 
   3.77458715	   10.02980042      32.70000100       1 
  10.06775522	   11.75619984      26.16000080       1 
  13.84362602	   11.75619984      28.34000087       1 
  15.10219955	   10.02980042      26.16000080       1 
  11.32632875	   10.02980042      28.34000087       1 
  10.06775522	   11.75619984      30.52000093       1 
  13.84362602	   11.75619984      32.70000100       1 
  15.10219955	   10.02980042      30.52000093       1 
  11.32632875	   10.02980042      32.70000100       1 
  17.61949682	   11.75619984      26.16000080       1 
  21.39536762	   11.75619984      28.34000087       1 
  22.65394115	   10.02980042      26.16000080       1 
  18.87807035	   10.02980042      28.34000087       1 
  17.61949682	   11.75619984      30.52000093       1 
  21.39536762	   11.75619984      32.70000100       1 
  22.65394115	   10.02980042      30.52000093       1 
  18.87807035	   10.02980042      32.70000100       1 
  25.17123842	   11.75619984      26.16000080       1 
  28.94710922	   11.75619984      28.34000087       1 
  30.20568275	   10.02980042      26.16000080       1 
  26.42981195	   10.02980042      28.34000087       1 
  25.17123842	   11.75619984      30.52000093       1 
  28.94710922	   11.75619984      32.70000100       1 
  30.20568275	   10.02980042      30.52000093       1 
  26.42981195	   10.02980042      32.70000100       1 
  32.72298002	   11.75619984      26.16000080       1 
  36.49885082	   11.75619984      28.34000087       1 
  37.75742435	   10.02980042      26.16000080       1 
  33.98155355	   10.02980042      28.34000087       1 
  32.72298002	   11.75619984      30.52000093       1 
  36.49885082	   11.75619984      32.70000100       1 
  37.75742435	   10.02980042      30.52000093       1 
  33.98155355	   10.02980042      32.70000100       1 
  40.27472162	   11.75619984      26.16000080       1 
  44.05059242	   11.75619984      28.34000087       1 
  45.30916595	   10.02980042      26.16000080       1 
  41.53329515	   10.02980042      28.34000087       1 
  40.27472162	   11.75619984      30.52000093       1 
  44.05059242	   11.75619984      32.70000100       1 
  45.30916595	   10.02980042      30.52000093       1 
  41.53329515	   10.02980042      32.70000100       1 
   2.51601362	   11.75619984      34.88000107       1 
   6.29188442	   11.75619984      37.06000114       1 
   7.55045795	   10.02980042      34.88000107       1 
   3.77458715	   10.02980042      37.06000114       1 
   2.51601362	   11.75619984      39.24000120       1 
   6.29188442	   11.75619984      41.42000127       1 
   7.55045795	   10.02980042      39.24000120       1 
   3.77458715	   10.02980042      41.42000127       1 
  10.06775522	   11.75619984      34.88000107       1 
  13.84362602	   11.75619984      37.06000114       1 
  15.10219955	   10.02980042      34.88000107       1 
  11.32632875	   10.02980042      37.06000114       1 
  10.06775522	   11.75619984      39.24000120       1 
  13.84362602	   11.75619984      41.42000127       1 
  15.10219955	   10.02980042      39.24000120       1 
  11.32632875	   10.02980042      41.42000127       1 
  17.61949682	   11.75619984      34.88000107       1 
  21.39536762	   11.75619984      37.06000114       1 
  22.65394115	   10.02980042      34.88000107       1 
  18.87807035	   10.02980042      37.06000114       1 
  17.61949682	   11.75619984      39.24000120       1 
  21.39536762	   11.75619984      41.42000127       1 
  22.65394115	   10.02980042      39.24000120       1 
  18.87807035	   10.02980042      41.42000127       1 
  25.17123842	   11.75619984      34.88000107       1 
  28.94710922	   11.75619984      37.06000114       1 
  30.20568275	   10.02980042      34.88000107       1 
  26.42981195	   10.02980042      37.06000114       1 
  25.17123842	   11.75619984      39.24000120       1 
  28.94710922	   11.75619984      41.42000127       1 
  30.20568275	   10.02980042      39.24000120       1 
  26.42981195	   10.02980042      41.42000127       1 
  32.72298002	   11.75619984      34.88000107       1 
  36.49885082	   11.75619984      37.06000114       1 
  37.75742435	   10.02980042      34.88000107       1 
  33.98155355	   10.02980042      37.06000114       1 
  32.72298002	   11.75619984      39.24000120       1 
  36.49885082	   11.75619984      41.42000127       1 
  37.75742435	   10.02980042      39.24000120       1 
  33.98155355	   10.02980042      41.42000127       1 
  40.27472162	   11.75619984      34.88000107       1 
  44.05059242	   11.75619984      37.06000114       1 
  45.30916595	   10.02980042      34.88000107       1 
  41.53329515	   10.02980042      37.06000114       1 
  40.27472162	   11.75619984      39.24000120       1 
  44.05059242	   11.75619984      41.42000127       1 
  45.30916595	   10.02980042      39.24000120       1 
  41.53329515	   10.02980042      41.42000127       1 
   2.51601362	   11.75619984      43.60000134       1 
   6.29188442	   11.75619984      45.78000140       1 
   7.55045795	   10.02980042      43.60000134       1 
   3.77458715	   10.02980042      45.78000140       1 
   2.51601362	   11.75619984      47.96000147       1 
   6.29188442	   11.75619984      50.14000154       1 
   7.55045795	   10.02980042      47.96000147       1 
   3.77458715	   10.02980042      50.14000154       1 
  10.06775522	   11.75619984      43.60000134       1 
  13.84362602	   11.75619984      45.78000140       1 
  15.10219955	   10.02980042      43.60000134       1 
  11.32632875	   10.02980042      45.78000140       1 
  10.06775522	   11.75619984      47.96000147       1 
  13.84362602	   11.75619984      50.14000154       1 
  15.10219955	   10.02980042      47.96000147       1 
  11.32632875	   10.02980042      50.14000154       1 
  17.61949682	   11.75619984      43.60000134       1 
  21.39536762	   11.75619984      45.78000140       1 
  22.65394115	   10.02980042      43.60000134       1 
  18.87807035	   10.02980042      45.78000140       1 
  17.61949682	   11.75619984      47.96000147       1 
  21.39536762	   11.75619984      50.14000154       1 
  22.65394115	   10.02980042      47.96000147       1 
  18.87807035	   10.02980042      50.14000154       1 
  25.17123842	   11.75619984      43.60000134       1 
  28.94710922	   11.75619984      45.78000140       1 
  30.20568275	   10.02980042      43.60000134       1 
  26.42981195	   10.02980042      45.78000140       1 
  25.17123842	   11.75619984      47.96000147       1 
  28.94710922	   11.75619984      50.14000154       1 
  30.20568275	   10.02980042      47.96000147       1 
  26.42981195	   10.02980042      50.14000154       1 
  32.72298002	   11.75619984      43.60000134       1 
  36.49885082	   11.75619984      45.78000140       1 
  37.75742435	   10.02980042      43.60000134       1 
  33.98155355	   10.02980042      45.78000140       1 
  32.72298002	   11.75619984      47.96000147       1 
  36.49885082	   11.75619984      50.14000154       1 
  37.75742435	   10.02980042      47.96000147       1 
  33.98155355	   10.02980042      50.14000154       1 
  40.27472162	   11.75619984      43.60000134       1 
  44.05059242	   11.75619984      45.78000140       1 
  45.30916595	   10.02980042      43.60000134       1 
  41.53329515	   10.02980042      45.78000140       1 
  40.27472162	   11.75619984      47.96000147       1 
  44.05059242	   11.75619984      50.14000154       1 
  45.30916595	   10.02980042      47.96000147       1 
  41.53329515	   10.02980042      50.14000154       1 
%endblock  AtomicCoordinatesAndAtomicSpecies

==================================================
==================================================
# SCF variables

DM.MixSCF1   T
MaxSCFIterations      300           # Maximum number of SCF iter
DM.MixingWeight       0.05          # New DM amount for next SCF cycle
DM.Tolerance          1.d-4         # Tolerance in maximum difference
DM.UseSaveDM          true          # to use continuation files
DM.NumberPulay        5

==================================================
==================================================
# MD variables

MD.FinalTimeStep 1
MD.TypeOfRun CG
MD.NumCGsteps     000
MD.UseSaveXV      .true.

==================================================
==================================================
# Output variables

WriteMullikenPop                1
WriteBands                      .false.
SaveRho                         .false.
SaveDeltaRho                    .false.
SaveHS                          .true.
SaveElectrostaticPotential      .true. 
SaveTotalPotential              .true.
WriteCoorXmol                   .true.
WriteMDXmol                     .true.
WriteMDhistory                  .false.
WriteEigenvalues                .true.
XML.Write              	        .true.

==================================================
==================================================
#Other options

TS.HS.Save          .true.
TS.DE.Save          .true.
ParallelOverK       .true.
User.Basis          .true.
Diag.ParallelOverK  .true. 

==================================================
==================================================
#####################TRANSIESTA###################

# Bias voltage


TS.Voltage $i eV



%block TS.ChemPots
  Left
  Right
%endblock TS.ChemPots

%block TS.ChemPot.Left
  mu V/2
  contour.eq
    begin
      c-Left
      t-Left
    end
%endblock TS.ChemPot.Left
%block TS.ChemPot.Right
  mu -V/2
  contour.eq
    begin
      c-Right
      t-Right
    end
%endblock TS.ChemPot.Right

TS.Elecs.Bulk true
TS.Elecs.DM.Update none
TS.Elecs.GF.ReUse false
%block TS.Elecs
  Left
  Right
%endblock TS.Elecs

%block TS.Elec.Left
  TSHS ./elec_bi.TSHS
  chem-pot Left
  semi-inf-dir -a3
  elec-pos begin 1
%endblock TS.Elec.Left

%block TS.Elec.Right
  TSHS ./elec_bi.TSHS
  chem-pot Right
  semi-inf-dir +a3
  elec-pos end -1
%endblock TS.Elec.Right

TS.Contours.Eq.Pole 2.5 eV
%block TS.Contour.c-Left
  part circle
   from   -40.00000 eV + V/2 to -10. kT + V/2
    points 30
     method g-legendre
%endblock TS.Contour.c-Left
%block TS.Contour.t-Left
  part tail
   from prev to inf
    points 10
     method g-fermi
%endblock TS.Contour.t-Left
%block TS.Contour.c-Right
  part circle
   from   -40.00000 eV - V/2 to -10. kT - V/2
    points 30
     method g-legendre
%endblock TS.Contour.c-Right
%block TS.Contour.t-Right
  part tail
   from prev to inf
    points 10
     method g-fermi
%endblock TS.Contour.t-Right

TS.Contours.nEq.Eta 0.0001 eV
%block TS.Contours.nEq
  neq
%endblock TS.Contours.nEq
%block TS.Contour.nEq.neq
  part line
   from -|V|/2 - 5 kT to |V|/2 + 5 kT
    delta 0.01 eV
     method mid-rule
%endblock TS.Contour.nEq.neq

TBT.DOS.A.All T
TS.SolutionMethod btd
TS.BTD.Pivot atom+Left
#TS.Elecs.Neglect.Principal true
==================================================
==================================================

EOF


/software/sse/easybuild/prefix/software/Siesta/4.1-b4-intel-2018a-nsc1/bin/tbtrans <POSCAR.fdf> TBT.out
cat TBT.out | grep "Left -> Right" | awk '{print $9    $11     $12}' >> ../IV.dat

cd ..
rm -rf cont
mkdir cont


rsync -aP --exclude=bi_scat.TBT.nc ./$i/bi_scat.TSDE ./$i/bi_scat.TSHS ./$i/bi_scat.DM cont  # copy these files for continuation of the next bias step.

done

