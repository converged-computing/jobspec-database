{
    "application": "Slurm",
    "details": {
        "job_name": "cpt-llama2_random_scale4_112gpus_dynamic_data",
        "output_file": "/mnt/petrelfs/share_data/quxiaoye/runs/llama2_random_scale4_112gpus_dynamic_data/%x-%j.log",
        "error_file": "/mnt/petrelfs/share_data/quxiaoye/runs/llama2_random_scale4_112gpus_dynamic_data/%x-%j.log",
        "partition": "MoE",
        "nodes": 14,
        "tasks_per_node": 1,
        "cpus_per_task": 64,
        "memory": 0,
        "gpus_per_node": 8,
        "quota_type": "reserved",
        "conda_environment": "smoe",
        "environment_variables": {
            "OMP_NUM_THREADS": "32",
            "LOGLEVEL": "INFO"
        },
        "model_type": "llama_moe",
        "pretrained_model": "/mnt/petrelfs/share_data/quxiaoye/models/LlamaMoEForCausalLM/Random/llama2_7B-16Select4-up_proj-Scale4.0",
        "tokenizer_path": "/mnt/petrelfs/share_data/quxiaoye/models/llama2_7B",
        "dataset_dir": "/mnt/petrelfs/share_data/quxiaoye/SlimPajama_processed",
        "validation_dir": "/mnt/petrelfs/share_data/quxiaoye/data/llama1_7B_val_set_tokenized",
        "learning_rate": "2e-4",
        "final_lr_portion": "0.1",
        "per_device_train_batch_size": 8,
        "per_device_eval_batch_size": 8,
        "gradient_accumulation_steps": 4,
        "block_size": 4096,
        "num_tokens": "200*10^9",
        "warmup_tokens": "15*10^8",
        "eval_tokens": "2.5*10^9",
        "seed": 1227,
        "deepspeed_config_file": "conf/deepspeed/bf16_zero1_default.json",
        "num_selects": 4,
        "data_cache": "resources/cache",
        "base_dir": "/mnt/petrelfs/share_data/quxiaoye/runs/llama2_random_scale4_112gpus_dynamic_data",
        "output_dir": "${base_dir}/outputs/${SLURM_JOB_NAME}-${SLURM_JOB_ID}",
        "command": "torchrun",
        "arguments": {
            "--nnodes": "${num_nodes}",
            "--nproc_per_node": "${num_gpu_per_node}",
            "--node_rank": "${SLURM_NODEID}",
            "--rdzv_id": "$RANDOM",
            "--rdzv_backend": "c10d",
            "--rdzv_endpoint": "${head_node}:29518",
            "smoe/entrypoint/cpt/cpt_fpt.py": [
                "--prob_map",
                "sheared_llama",
                "--deepspeed",
                "${deepspeed_config_file}",
                "--model_name_or_path",
                "${pretrained_model}",
                "--model_type",
                "${model_type}",
                "--tokenizer_name_or_path",
                "${tokenizer_path}",
                "--dataset_dir",
                "${dataset_dir}",
                "--data_cache_dir",
                "${data_cache}",
                "--validation_dir",
                "${validation_dir}",
                "--per_device_train_batch_size",
                "${per_device_train_batch_size}",
                "--per_device_eval_batch_size",
                "${per_device_eval_batch_size}",
                "--do_train",
                "--evaluation_strategy",
                "steps",
                "--eval_steps",
                "${eval_steps}",
                "--seed",
                "${seed}",
                "--bf16",
                "--num_train_epochs",
                "1",
                "--final_lr_portion",
                "${final_lr_portion}",
                "--optim",
                "adamw_torch",
                "--adam_beta1",
                "0.9",
                "--adam_beta2",
                "0.95",
                "--learning_rate",
                "${lr}",
                "--weight_decay",
                "0.1",
                "--max_grad_norm",
                "1.0",
                "--warmup_steps",
                "${warmup_steps}",
                "--max_steps",
                "${max_steps}",
                "--max_train_samples",
                "${max_train_samples}",
                "--save_strategy",
                "steps",
                "--save_total_limit",
                "1",
                "--save_steps",
                "${eval_steps}",
                "--dataloader_num_workers",
                "0",
                "--dataloader_pin_memory",
                "True",
                "--gradient_accumulation_steps",
                "${gradient_accumulation_steps}",
                "--block_size",
                "${block_size}",
                "--output_dir",
                "${output_dir}",
                "--overwrite_output_dir",
                "--ddp_timeout",
                "3600",
                "--ddp_find_unused_parameters",
                "False",
                "--torch_dtype",
                "bfloat16",
                "--gradient_checkpointing",
                "--logging_first_step",
                "True",
                "--logging_strategy",
                "steps",
                "--logging_steps",
                "5",
                "--log_level",
                "info",
                "--log_level_replica",
                "warning",
                "--log_on_each_node",
                "False",
                "--report_to",
                "none",
                "--gate_type",
                "TopKBalancedNoisyGate",
                "--calculator_type",
                "UniversalCalculator",
                "--num_selects",
                "${num_selects}"
            ]
        },
        "software": [
            "Slurm",
            "conda",
            "torchrun",
            "deepspeed",
            "python",
            "git"
        ]
    }
}